on:
  workflow_dispatch:
  push:
    branches:
        - master
        - main
  pull_request:
    branches:
      - master
      - main
    types:
      - opened
      - synchronize
jobs:
  scan_job:
    name: Boost Security Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: BoostSecurity Scanner
        uses: peaudecastor/boost-security-scanner-github@v2
        with:
          action: scan
          additional_args: --partial
          api_endpoint: https://api.boostsecurity.dev
          api_token: ${{ secrets.BOOST_API_TOKEN_STAGING }}
          scanner_image: public.ecr.aws/k5x5n4t0/boost-security-scanner
          scanner_version: latest
  java_job:
    name: Java Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: adopt
          cache: maven
      - name: Prepare Java scanner script
        run: |
          cat << EOF > /usr/local/bin/scan.sh
          #!/bin/bash
          set -e
          mvn clean compile com.github.spotbugs:spotbugs-maven-plugin:spotbugs -Dspotbugs.failOnError=false -Dspotbugs.sarifOutput=true -Dspotbugs.sarifFullPath=true > /dev/null
          jq '.runs[].invocations[].executionSuccessful=true' target/spotbugsSarif.json
          EOF
          chmod +x /usr/local/bin/scan.sh
      - name: Java Scanner
        uses: peaudecastor/boost-security-scanner-github@v2
        with:
          action: exec
          additional_args: --partial --require-full-repo
          exec_command: /usr/local/bin/scan.sh
          api_endpoint: https://api.boostsecurity.dev
          api_token: ${{ secrets.BOOST_API_TOKEN_STAGING }}
          scanner_image: public.ecr.aws/k5x5n4t0/boost-security-scanner
          scanner_version: latest
  complete_scan:
    name: Complete Scan
    needs: [scan_job, java_job]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Complete Scan
        uses: peaudecastor/boost-security-scanner-github@v2
        with:
          action: complete
          api_endpoint: https://api.boostsecurity.dev
          api_token: ${{ secrets.BOOST_API_TOKEN_STAGING }}
          scanner_image: public.ecr.aws/k5x5n4t0/boost-security-scanner
          scanner_version: latest
